<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Spatial Analysis and Statistical Modeling with R and spmodel - 4&nbsp; GIS in R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./watershed-delineation.html" rel="next">
<link href="./spglm.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">GIS in R</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Spatial Analysis and Statistical Modeling with R and spmodel</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Welcome</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./splm.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Spatial Linear Models (SPLMs) in <code>spmodel</code></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./splm-additional.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Additional <code>spmodel</code> Features</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spglm.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial Generalized Linear Models (SPGLMs) in <code>spmodel</code></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gis-in-r.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">GIS in R</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./watershed-delineation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Watershed Delineation in <code>R</code></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./streamcattools.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">StreamCat &amp; LakeCat</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spatial-lm.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">A SPLM Application to Lake Conductivity</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spatial-glm.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">A SPGLM Application to the “Dancer” Damselfly (<em>Argia</em>)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#goals-and-motivation" id="toc-goals-and-motivation" class="nav-link active" data-scroll-target="#goals-and-motivation"><span class="toc-section-number">4.1</span>  Goals and Motivation</a></li>
  <li>
<a href="#points-lines-and-polygons" id="toc-points-lines-and-polygons" class="nav-link" data-scroll-target="#points-lines-and-polygons"><span class="toc-section-number">4.2</span>  Points, lines, and polygons</a>
  <ul>
<li><a href="#exploring-the-simple-features-sf-package" id="toc-exploring-the-simple-features-sf-package" class="nav-link" data-scroll-target="#exploring-the-simple-features-sf-package"><span class="toc-section-number">4.2.1</span>  Exploring the Simple Features (<code>sf</code>) package</a></li>
  <li><a href="#coordinate-reference-systems" id="toc-coordinate-reference-systems" class="nav-link" data-scroll-target="#coordinate-reference-systems"><span class="toc-section-number">4.2.2</span>  Coordinate Reference Systems</a></li>
  <li><a href="#it-all-feels-like-r" id="toc-it-all-feels-like-r" class="nav-link" data-scroll-target="#it-all-feels-like-r"><span class="toc-section-number">4.2.3</span>  It all feels like <code>R</code></a></li>
  </ul>
</li>
  <li>
<a href="#raster-data" id="toc-raster-data" class="nav-link" data-scroll-target="#raster-data"><span class="toc-section-number">4.3</span>  Raster data</a>
  <ul>
<li><a href="#stacking-raster-data" id="toc-stacking-raster-data" class="nav-link" data-scroll-target="#stacking-raster-data"><span class="toc-section-number">4.3.1</span>  Stacking raster data</a></li>
  </ul>
</li>
  <li><a href="#working-with-real-data" id="toc-working-with-real-data" class="nav-link" data-scroll-target="#working-with-real-data"><span class="toc-section-number">4.4</span>  Working with real data</a></li>
  <li><a href="#r-code-appendix" id="toc-r-code-appendix" class="nav-link" data-scroll-target="#r-code-appendix"><span class="toc-section-number">4.5</span>  R Code Appendix</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="gis-in-r" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">GIS in R</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><div class="cell">

</div>
<p>Throughout this section, we will use the following packages:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/FedData/">FedData</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dieghernan.github.io/tidyterra/">tidyterra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">maps</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="goals-and-motivation" class="level2" data-number="4.1"><h2 data-number="4.1" class="anchored" data-anchor-id="goals-and-motivation">
<span class="header-section-number">4.1</span> Goals and Motivation</h2>
<p>Maintaining all analyses within a single software (<code>R</code>) can greatly simplify your research workflow. In this section, we’ll cover the basics of doing GIS in <code>R</code>.</p>
<p>By the end of this lesson, you should be able to:</p>
<ul>
<li>Understand the main features and types of vector data.</li>
<li>Generate point data from a set of latitudes and longitudes, such as from fields sites.</li>
<li>Read, write, query, and manipulate vector data using the <code>sf</code> package.</li>
<li>Understand the main features of raster data.</li>
<li>Access, manipulate, and stack raster layers.</li>
<li>Generate summaries of raster data within vector polygon layers.</li>
</ul></section><section id="points-lines-and-polygons" class="level2" data-number="4.2"><h2 data-number="4.2" class="anchored" data-anchor-id="points-lines-and-polygons">
<span class="header-section-number">4.2</span> Points, lines, and polygons</h2>
<p>These data are a way of representing real-world features on a landscape in a highly simplified way. The simplest of these features is a point, which is a 0-dimensional feature that can be used to represent a specific location on the earth, such as a single tree or an entire city. Linear, 1-dimensional features can be represented with points (or vertices) that are connected by a path to form a line and when many points are connected these form a polyline. Finally, when a polyline’s path returns to its origin to represent an enclosed space, such as a forest, watershed boundary, or lake, this forms a polygon.</p>
<div id="fig-foo" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figures/pts-lines-polys.png" style="height:100.0%" class="figure-img"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;4.1: Vector data. Image from: https://earthdatascience.org/courses/earth-analytics/spatial-data-r/intro-vector-data-r/</figcaption><p></p>
</figure>
</div>
<p>We can represent these features in <code>R</code> without actually using GIS packages. In this example, we’ll represent several cities in Oregon with common <code>R</code> data structures that you are probably already familiar with.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">cities</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Ashland'</span>,<span class="st">'Corvallis'</span>,<span class="st">'Bend'</span>,<span class="st">'Portland'</span>,<span class="st">'Newport'</span><span class="op">)</span></span>
<span><span class="va">longitude</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">122.699</span>, <span class="op">-</span><span class="fl">123.275</span>, <span class="op">-</span><span class="fl">121.313</span>, <span class="op">-</span><span class="fl">122.670</span>, <span class="op">-</span><span class="fl">124.054</span><span class="op">)</span></span>
<span><span class="va">latitude</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">42.189</span>, <span class="fl">44.57</span>, <span class="fl">44.061</span>, <span class="fl">45.523</span>, <span class="fl">44.652</span><span class="op">)</span></span>
<span><span class="va">population</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20062</span>, <span class="fl">50297</span>, <span class="fl">61362</span>, <span class="fl">537557</span>, <span class="fl">9603</span><span class="op">)</span></span>
<span></span>
<span><span class="va">oregon_cities</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">cities</span>, <span class="va">longitude</span>, <span class="va">latitude</span>, <span class="va">population</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">oregon_cities</span>, </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">longitude</span>, y <span class="op">=</span> <span class="va">latitude</span>, size <span class="op">=</span> <span class="va">population</span>, label <span class="op">=</span> <span class="va">cities</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">1</span>, vjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-oregon-cities1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="gis-in-r_files/figure-html/fig-oregon-cities1-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;4.2: Oregon cities plotted from data frame.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>So, is this sufficient for working with spatial data in <code>R</code> and doing spatial analysis? What are we missing?</p>
<p>If you have worked with vector data before, you may know that these data also usually have:</p>
<ul>
<li>A coordinate reference system</li>
<li>A bounding box or extent</li>
<li>Plot order</li>
<li>Additional data</li>
</ul>
<p>In the next section we will introduce the <code>sf</code> package that will allow us to take fuller advantage of spatial features in <code>R</code>.</p>
<section id="exploring-the-simple-features-sf-package" class="level3" data-number="4.2.1"><h3 data-number="4.2.1" class="anchored" data-anchor-id="exploring-the-simple-features-sf-package">
<span class="header-section-number">4.2.1</span> Exploring the Simple Features (<code>sf</code>) package</h3>
<p>The <a href="https://github.com/r-spatial/sf/"><code>sf</code> package</a> provides <a href="https://en.wikipedia.org/wiki/Simple_Features">simple features access</a> for <code>R</code>. <code>sf</code> fits in within the “tidy” approach to data of Hadley Wickham’s <code>tidyverse</code> and is an ever-expanding package with 113 contributors in GitHub. In short, much of what used to require ArcGIS license can now be done in <code>R</code> with <code>sf</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="st">"package:sf"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   [1] "%&gt;%"                          "as_Spatial"                  </span></span>
<span><span class="co">#&gt;   [3] "dbDataType"                   "dbWriteTable"                </span></span>
<span><span class="co">#&gt;   [5] "gdal_addo"                    "gdal_create"                 </span></span>
<span><span class="co">#&gt;   [7] "gdal_crs"                     "gdal_extract"                </span></span>
<span><span class="co">#&gt;   [9] "gdal_inv_geotransform"        "gdal_metadata"               </span></span>
<span><span class="co">#&gt;  [11] "gdal_polygonize"              "gdal_rasterize"              </span></span>
<span><span class="co">#&gt;  [13] "gdal_read"                    "gdal_read_mdim"              </span></span>
<span><span class="co">#&gt;  [15] "gdal_subdatasets"             "gdal_utils"                  </span></span>
<span><span class="co">#&gt;  [17] "gdal_write"                   "gdal_write_mdim"             </span></span>
<span><span class="co">#&gt;  [19] "get_key_pos"                  "NA_agr_"                     </span></span>
<span><span class="co">#&gt;  [21] "NA_bbox_"                     "NA_crs_"                     </span></span>
<span><span class="co">#&gt;  [23] "NA_m_range_"                  "NA_z_range_"                 </span></span>
<span><span class="co">#&gt;  [25] "plot_sf"                      "rawToHex"                    </span></span>
<span><span class="co">#&gt;  [27] "read_sf"                      "sf.colors"                   </span></span>
<span><span class="co">#&gt;  [29] "sf_add_proj_units"            "sf_extSoftVersion"           </span></span>
<span><span class="co">#&gt;  [31] "sf_proj_info"                 "sf_proj_network"             </span></span>
<span><span class="co">#&gt;  [33] "sf_proj_pipelines"            "sf_proj_search_paths"        </span></span>
<span><span class="co">#&gt;  [35] "sf_project"                   "sf_use_s2"                   </span></span>
<span><span class="co">#&gt;  [37] "st_agr"                       "st_agr&lt;-"                    </span></span>
<span><span class="co">#&gt;  [39] "st_area"                      "st_as_binary"                </span></span>
<span><span class="co">#&gt;  [41] "st_as_grob"                   "st_as_s2"                    </span></span>
<span><span class="co">#&gt;  [43] "st_as_sf"                     "st_as_sfc"                   </span></span>
<span><span class="co">#&gt;  [45] "st_as_text"                   "st_axis_order"               </span></span>
<span><span class="co">#&gt;  [47] "st_bbox"                      "st_bind_cols"                </span></span>
<span><span class="co">#&gt;  [49] "st_boundary"                  "st_break_antimeridian"       </span></span>
<span><span class="co">#&gt;  [51] "st_buffer"                    "st_can_transform"            </span></span>
<span><span class="co">#&gt;  [53] "st_cast"                      "st_centroid"                 </span></span>
<span><span class="co">#&gt;  [55] "st_collection_extract"        "st_combine"                  </span></span>
<span><span class="co">#&gt;  [57] "st_concave_hull"              "st_contains"                 </span></span>
<span><span class="co">#&gt;  [59] "st_contains_properly"         "st_convex_hull"              </span></span>
<span><span class="co">#&gt;  [61] "st_coordinates"               "st_covered_by"               </span></span>
<span><span class="co">#&gt;  [63] "st_covers"                    "st_crop"                     </span></span>
<span><span class="co">#&gt;  [65] "st_crosses"                   "st_crs"                      </span></span>
<span><span class="co">#&gt;  [67] "st_crs&lt;-"                     "st_delete"                   </span></span>
<span><span class="co">#&gt;  [69] "st_difference"                "st_dimension"                </span></span>
<span><span class="co">#&gt;  [71] "st_disjoint"                  "st_distance"                 </span></span>
<span><span class="co">#&gt;  [73] "st_drivers"                   "st_drop_geometry"            </span></span>
<span><span class="co">#&gt;  [75] "st_equals"                    "st_equals_exact"             </span></span>
<span><span class="co">#&gt;  [77] "st_filter"                    "st_geometry"                 </span></span>
<span><span class="co">#&gt;  [79] "st_geometry_type"             "st_geometry&lt;-"               </span></span>
<span><span class="co">#&gt;  [81] "st_geometrycollection"        "st_graticule"                </span></span>
<span><span class="co">#&gt;  [83] "st_inscribed_circle"          "st_interpolate_aw"           </span></span>
<span><span class="co">#&gt;  [85] "st_intersection"              "st_intersects"               </span></span>
<span><span class="co">#&gt;  [87] "st_is"                        "st_is_empty"                 </span></span>
<span><span class="co">#&gt;  [89] "st_is_longlat"                "st_is_simple"                </span></span>
<span><span class="co">#&gt;  [91] "st_is_valid"                  "st_is_within_distance"       </span></span>
<span><span class="co">#&gt;  [93] "st_jitter"                    "st_join"                     </span></span>
<span><span class="co">#&gt;  [95] "st_layers"                    "st_length"                   </span></span>
<span><span class="co">#&gt;  [97] "st_line_interpolate"          "st_line_merge"               </span></span>
<span><span class="co">#&gt;  [99] "st_line_project"              "st_line_sample"              </span></span>
<span><span class="co">#&gt; [101] "st_linestring"                "st_m_range"                  </span></span>
<span><span class="co">#&gt; [103] "st_make_grid"                 "st_make_valid"               </span></span>
<span><span class="co">#&gt; [105] "st_minimum_rotated_rectangle" "st_multilinestring"          </span></span>
<span><span class="co">#&gt; [107] "st_multipoint"                "st_multipolygon"             </span></span>
<span><span class="co">#&gt; [109] "st_nearest_feature"           "st_nearest_points"           </span></span>
<span><span class="co">#&gt; [111] "st_node"                      "st_normalize"                </span></span>
<span><span class="co">#&gt; [113] "st_overlaps"                  "st_perimeter"                </span></span>
<span><span class="co">#&gt; [115] "st_point"                     "st_point_on_surface"         </span></span>
<span><span class="co">#&gt; [117] "st_polygon"                   "st_polygonize"               </span></span>
<span><span class="co">#&gt; [119] "st_precision"                 "st_precision&lt;-"              </span></span>
<span><span class="co">#&gt; [121] "st_read"                      "st_read_db"                  </span></span>
<span><span class="co">#&gt; [123] "st_relate"                    "st_reverse"                  </span></span>
<span><span class="co">#&gt; [125] "st_sample"                    "st_segmentize"               </span></span>
<span><span class="co">#&gt; [127] "st_set_agr"                   "st_set_crs"                  </span></span>
<span><span class="co">#&gt; [129] "st_set_geometry"              "st_set_precision"            </span></span>
<span><span class="co">#&gt; [131] "st_sf"                        "st_sfc"                      </span></span>
<span><span class="co">#&gt; [133] "st_shift_longitude"           "st_simplify"                 </span></span>
<span><span class="co">#&gt; [135] "st_snap"                      "st_sym_difference"           </span></span>
<span><span class="co">#&gt; [137] "st_touches"                   "st_transform"                </span></span>
<span><span class="co">#&gt; [139] "st_triangulate"               "st_triangulate_constrained"  </span></span>
<span><span class="co">#&gt; [141] "st_union"                     "st_viewport"                 </span></span>
<span><span class="co">#&gt; [143] "st_voronoi"                   "st_within"                   </span></span>
<span><span class="co">#&gt; [145] "st_wrap_dateline"             "st_write"                    </span></span>
<span><span class="co">#&gt; [147] "st_write_db"                  "st_z_range"                  </span></span>
<span><span class="co">#&gt; [149] "st_zm"                        "vec_cast.sfc"                </span></span>
<span><span class="co">#&gt; [151] "vec_ptype2.sfc"               "write_sf"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Important for us today - the <code>sf</code> package is fast and simple to use. To get a sense of why simple features are simple, let’s make one from our Oregon cities.</p>
<p>In this code we will…</p>
<ul>
<li>Convert an existing data frame to a simple feature by:</li>
<li>Supply the longitude and latitude (x and y).</li>
<li>Define the (geographic) coordinate reference system (<code>crs</code>).</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">oregon_cities</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id    cities longitude latitude population</span></span>
<span><span class="co">#&gt; 1  1   Ashland  -122.699   42.189      20062</span></span>
<span><span class="co">#&gt; 2  2 Corvallis  -123.275   44.570      50297</span></span>
<span><span class="co">#&gt; 3  3      Bend  -121.313   44.061      61362</span></span>
<span><span class="co">#&gt; 4  4  Portland  -122.670   45.523     537557</span></span>
<span><span class="co">#&gt; 5  5   Newport  -124.054   44.652       9603</span></span>
<span></span>
<span><span class="va">oregon_cities</span> <span class="op">&lt;-</span> <span class="va">oregon_cities</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'longitude'</span>, <span class="st">'latitude'</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4269</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">oregon_cities</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 5 features and 3 fields</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -124.054 ymin: 42.189 xmax: -121.313 ymax: 45.523</span></span>
<span><span class="co">#&gt; Geodetic CRS:  NAD83</span></span>
<span><span class="co">#&gt;   id    cities population                geometry</span></span>
<span><span class="co">#&gt; 1  1   Ashland      20062 POINT (-122.699 42.189)</span></span>
<span><span class="co">#&gt; 2  2 Corvallis      50297  POINT (-123.275 44.57)</span></span>
<span><span class="co">#&gt; 3  3      Bend      61362 POINT (-121.313 44.061)</span></span>
<span><span class="co">#&gt; 4  4  Portland     537557  POINT (-122.67 45.523)</span></span>
<span><span class="co">#&gt; 5  5   Newport       9603 POINT (-124.054 44.652)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Reading and Writing vector files
</div>
</div>
<div class="callout-body-container callout-body">
<p>For reference, <code>sf</code> makes it very easy to write and read spatial objects in <code>R</code>, such as ESRI shapefiles:</p>
<p>To write an <code>sf</code> object out as an ESRI shapefile:</p>
<p><code>st_write(oregon_cities, dsn = 'oregon_cities.shp')</code></p>
<p>To read an ESRI shapefile:</p>
<p><code>oregon_cities &lt;- st_read('oregon_cities.shp')</code></p>
<p>These operations can also be done with <code>write_sf</code> and <code>read_sf</code> but with slightly different options.</p>
</div>
</div>
<p>When we print the <code>oregon_cities</code> object, we can see it has changed from being a standard data frame. It now includes features that are required for a true spatial object:</p>
<ul>
<li>Geometry type</li>
<li>Bounding box</li>
<li>Coordinate reference system</li>
</ul>
<p>In addition, we see that the latitude and longitude columns have been moved to a new column called <code>"geometry"</code> that appears in parentheses. Unlike sp, simple features contain the geometric information in a single column. An important note about the geometry column is that it is “sticky”, meaning that we can manipulate the sf object, such as with select in <code>tidyverse</code> (e.g., with <code>dplyr</code>) without explicitly referencing the geometry column without losing it:</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">oregon_cities</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">cities</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 5 features and 1 field</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -124.054 ymin: 42.189 xmax: -121.313 ymax: 45.523</span></span>
<span><span class="co">#&gt; Geodetic CRS:  NAD83</span></span>
<span><span class="co">#&gt;      cities                geometry</span></span>
<span><span class="co">#&gt; 1   Ashland POINT (-122.699 42.189)</span></span>
<span><span class="co">#&gt; 2 Corvallis  POINT (-123.275 44.57)</span></span>
<span><span class="co">#&gt; 3      Bend POINT (-121.313 44.061)</span></span>
<span><span class="co">#&gt; 4  Portland  POINT (-122.67 45.523)</span></span>
<span><span class="co">#&gt; 5   Newport POINT (-124.054 44.652)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the above example, we selected the cities column and the returned feature still included the <code>"geometry"</code> column.</p>
</section><section id="coordinate-reference-systems" class="level3" data-number="4.2.2"><h3 data-number="4.2.2" class="anchored" data-anchor-id="coordinate-reference-systems">
<span class="header-section-number">4.2.2</span> Coordinate Reference Systems</h3>
<p><code>sf</code> also has functionality to re-project and manipulate spatial objects. For example, the coordinate reference system of the <code>sf</code> object is currently in degrees. For many applications, we may want to transform the data to have an equal area projection and to have x and y units of meters, such as the USGS’s <a href="https://epsg.org/crs_5070/NAD83-Conus-Albers.html?sessionkey=2havsqacn7">Albers Equal-Area Conic Projection</a>.</p>
<p>Although a full discussion of geographic projections is beyond the scope of this workshop, it’s worth understanding how they affect geographic data.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="figures/crs-comparisons.jpg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Image from: https://nceas.github.io/oss-lessons/spatial-data-gis-law/1-mon-spatial-data-intro.html</figcaption><p></p>
</figure>
</div>
<p>When we created the <code>oregon_cities</code> object, we defined the coordinate reference system with <code>crs = 4269</code>. Likewise, we can use the EPSG reference number of the Albers Equal-Area Conic Projection to transform the spatial object. At <a href="epsg.org">epsg.org</a>, we can see that this code is 5070.</p>
<p>In this code we:</p>
<ul>
<li>Check to see if the current CRS is equal to the Albers Equal-Area Conic Projection.</li>
<li>Transform <code>oregon_cities</code> to CRS 5070.</li>
<li>Plot the results with <code>ggplot</code> using the <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf_text()</a></code> and <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf()</a></code> functions.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">oregon_cities</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="fl">5070</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span></span>
<span><span class="va">oregon_cities</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">oregon_cities</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="fl">5070</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">oregon_cities</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 5 features and 3 fields</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -2188387 ymin: 2437735 xmax: -1997273 ymax: 2794360</span></span>
<span><span class="co">#&gt; Projected CRS: NAD83 / Conus Albers</span></span>
<span><span class="co">#&gt;   id    cities population                 geometry</span></span>
<span><span class="co">#&gt; 1  1   Ashland      20062 POINT (-2161785 2437735)</span></span>
<span><span class="co">#&gt; 2  2 Corvallis      50297 POINT (-2131908 2705899)</span></span>
<span><span class="co">#&gt; 3  3      Bend      61362 POINT (-1997273 2608702)</span></span>
<span><span class="co">#&gt; 4  4  Portland     537557 POINT (-2056514 2794360)</span></span>
<span><span class="co">#&gt; 5  5   Newport       9603 POINT (-2188387 2732355)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">oregon_cities</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">cities</span><span class="op">)</span>,</span>
<span>               hjust<span class="op">=</span><span class="fl">0</span>, vjust<span class="op">=</span><span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">population</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">'Longitude'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">'Latitude'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-oregon-cities2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="gis-in-r_files/figure-html/fig-oregon-cities2-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;4.3: Oregon cities plotted from sf object.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
EPSG Codes
</div>
</div>
<div class="callout-body-container callout-body">
<p>EPSG codes are unique identifiers that represent coordinate reference systems. Some commonly used EPSG codes include:</p>
<ul>
<li>4326: The WGS84 geographic coordinate reference system.</li>
<li>4269: The NAD83 geographic coordinate reference system.</li>
<li>5070: The NAD83 projected coordinate reference system.</li>
</ul>
</div>
</div>
</section><section id="it-all-feels-like-r" class="level3" data-number="4.2.3"><h3 data-number="4.2.3" class="anchored" data-anchor-id="it-all-feels-like-r">
<span class="header-section-number">4.2.3</span> It all feels like <code>R</code>
</h3>
<p>There can be huge advantages to doing GIS tasks in <code>R</code>, within one software system. If you are familiar with <code>R</code>, the leap to doing GIS in <code>R</code> will feel small.</p>
<p>As noted above, the <code>sf</code> package provides a variety of GIS functions, such as buffers, intersection, centroids, etc. In addition, these functions can be combined with <code>tidyverse</code> functions in piped procedures.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Plot 1:</span></span>
<span></span>
<span><span class="co"># Add 100 Km buffer to cities</span></span>
<span><span class="va">cities_buffer</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">oregon_cities</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span><span class="fl">100000</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Plot, color by city, and add centroids</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">cities_buffer</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">cities</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span><span class="va">oregon_cities</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="gis-in-r_files/figure-html/buffered-cities1-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Buffered cities w/ overlapping buffers.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Plot 2:</span></span>
<span></span>
<span><span class="va">oregon_cities</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  </span>
<span>  <span class="co"># 100 Km buffer</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span><span class="fl">100000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># Split polygons where buffers intersect</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">st_intersection</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># Add area to table, but drop units (causes issues with ggplot)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>area <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_area</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>           <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/drop_units.html">drop_units</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         id <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/is.bool.html">as.factor</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">id</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="gis-in-r_files/figure-html/buffered-cities2-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Buffered cities w/ overlapping buffers split.</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section></section><section id="raster-data" class="level2" data-number="4.3"><h2 data-number="4.3" class="anchored" data-anchor-id="raster-data">
<span class="header-section-number">4.3</span> Raster data</h2>
<p>Another fundamental data type in GIS is the raster. Rasters are a way of displaying gridded or an array of data, where each member of the grid represents a landscape feature (e.g., elevation) and each element also has a given resolution (e.g., 30m x 30m).</p>
<p>There are several packages available to work with rasters in <code>R</code>, including the original <code>raster</code>, but also now <code>terra</code>, and <code>stars</code>. We’ll use the <a href="https://github.com/rspatial/terra"><code>terra</code> package</a> since it has an active develoment community on GitHub and has taken over as the primary package for handling and viewing raster data. It is reported to be up to 7x faster than the original <code>raster</code> package for some processes. If you are familiar with <code>raster</code> it will feel very similar.</p>
<p>Much like <code>sf</code>, <code>terra</code> has a large number of functions for working with raster data.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="st">"package:terra"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   [1] "%in%"                  "activeCat"             "activeCat&lt;-"          </span></span>
<span><span class="co">#&gt;   [4] "add_box"               "add_legend"            "add&lt;-"                </span></span>
<span><span class="co">#&gt;   [7] "addCats"               "adjacent"              "aggregate"            </span></span>
<span><span class="co">#&gt;  [10] "align"                 "all.equal"             "allNA"                </span></span>
<span><span class="co">#&gt;  [13] "animate"               "app"                   "approximate"          </span></span>
<span><span class="co">#&gt;  [16] "area"                  "Arith"                 "as.array"             </span></span>
<span><span class="co">#&gt;  [19] "as.bool"               "as.contour"            "as.data.frame"        </span></span>
<span><span class="co">#&gt;  [22] "as.factor"             "as.int"                "as.lines"             </span></span>
<span><span class="co">#&gt;  [25] "as.list"               "as.matrix"             "as.points"            </span></span>
<span><span class="co">#&gt;  [28] "as.polygons"           "as.raster"             "atan_2"               </span></span>
<span><span class="co">#&gt;  [31] "atan2"                 "autocor"               "barplot"              </span></span>
<span><span class="co">#&gt;  [34] "blocks"                "boundaries"            "boxplot"              </span></span>
<span><span class="co">#&gt;  [37] "buffer"                "cartogram"             "catalyze"             </span></span>
<span><span class="co">#&gt;  [40] "categories"            "cats"                  "cbind2"               </span></span>
<span><span class="co">#&gt;  [43] "cellFromRowCol"        "cellFromRowColCombine" "cellFromXY"           </span></span>
<span><span class="co">#&gt;  [46] "cells"                 "cellSize"              "centroids"            </span></span>
<span><span class="co">#&gt;  [49] "clamp"                 "clamp_ts"              "classify"             </span></span>
<span><span class="co">#&gt;  [52] "clearance"             "click"                 "colFromCell"          </span></span>
<span><span class="co">#&gt;  [55] "colFromX"              "colorize"              "coltab"               </span></span>
<span><span class="co">#&gt;  [58] "coltab&lt;-"              "combineGeoms"          "compare"              </span></span>
<span><span class="co">#&gt;  [61] "Compare"               "compareGeom"           "concats"              </span></span>
<span><span class="co">#&gt;  [64] "contour"               "convHull"              "costDist"             </span></span>
<span><span class="co">#&gt;  [67] "countNA"               "cover"                 "crds"                 </span></span>
<span><span class="co">#&gt;  [70] "crop"                  "crosstab"              "crs"                  </span></span>
<span><span class="co">#&gt;  [73] "crs&lt;-"                 "datatype"              "deepcopy"             </span></span>
<span><span class="co">#&gt;  [76] "delaunay"              "densify"               "density"              </span></span>
<span><span class="co">#&gt;  [79] "depth"                 "depth&lt;-"               "describe"             </span></span>
<span><span class="co">#&gt;  [82] "diff"                  "direction"             "disagg"               </span></span>
<span><span class="co">#&gt;  [85] "distance"              "dots"                  "draw"                 </span></span>
<span><span class="co">#&gt;  [88] "droplevels"            "elongate"              "emptyGeoms"           </span></span>
<span><span class="co">#&gt;  [91] "erase"                 "expanse"               "ext"                  </span></span>
<span><span class="co">#&gt;  [94] "ext&lt;-"                 "extend"                "extract"              </span></span>
<span><span class="co">#&gt;  [97] "extractAlong"          "extractRange"          "fileBlocksize"        </span></span>
<span><span class="co">#&gt; [100] "fillHoles"             "fillTime"              "flip"                 </span></span>
<span><span class="co">#&gt; [103] "focal"                 "focal3D"               "focalCor"             </span></span>
<span><span class="co">#&gt; [106] "focalCpp"              "focalMat"              "focalPairs"           </span></span>
<span><span class="co">#&gt; [109] "focalReg"              "focalValues"           "forceCCW"             </span></span>
<span><span class="co">#&gt; [112] "free_RAM"              "freq"                  "gaps"                 </span></span>
<span><span class="co">#&gt; [115] "gdal"                  "gdalCache"             "geom"                 </span></span>
<span><span class="co">#&gt; [118] "geomtype"              "getGDALconfig"         "getTileExtents"       </span></span>
<span><span class="co">#&gt; [121] "global"                "graticule"             "gridDist"             </span></span>
<span><span class="co">#&gt; [124] "gridDistance"          "halo"                  "has.colors"           </span></span>
<span><span class="co">#&gt; [127] "has.RGB"               "has.time"              "hasMinMax"            </span></span>
<span><span class="co">#&gt; [130] "hasValues"             "head"                  "hist"                 </span></span>
<span><span class="co">#&gt; [133] "identical"             "ifel"                  "image"                </span></span>
<span><span class="co">#&gt; [136] "impose"                "inext"                 "init"                 </span></span>
<span><span class="co">#&gt; [139] "inMemory"              "inset"                 "interpIDW"            </span></span>
<span><span class="co">#&gt; [142] "interpNear"            "interpolate"           "intersect"            </span></span>
<span><span class="co">#&gt; [145] "is.bool"               "is.empty"              "is.factor"            </span></span>
<span><span class="co">#&gt; [148] "is.int"                "is.lines"              "is.lonlat"            </span></span>
<span><span class="co">#&gt; [151] "is.points"             "is.polygons"           "is.related"           </span></span>
<span><span class="co">#&gt; [154] "is.rotated"            "is.valid"              "isFALSE"              </span></span>
<span><span class="co">#&gt; [157] "isTRUE"                "k_means"               "lapp"                 </span></span>
<span><span class="co">#&gt; [160] "layerCor"              "levels"                "linearUnits"          </span></span>
<span><span class="co">#&gt; [163] "lines"                 "logic"                 "Logic"                </span></span>
<span><span class="co">#&gt; [166] "longnames"             "longnames&lt;-"           "makeNodes"            </span></span>
<span><span class="co">#&gt; [169] "makeTiles"             "makeValid"             "makeVRT"              </span></span>
<span><span class="co">#&gt; [172] "map.pal"               "mask"                  "match"                </span></span>
<span><span class="co">#&gt; [175] "math"                  "Math"                  "Math2"                </span></span>
<span><span class="co">#&gt; [178] "mean"                  "median"                "mem_info"             </span></span>
<span><span class="co">#&gt; [181] "merge"                 "mergeLines"            "mergeTime"            </span></span>
<span><span class="co">#&gt; [184] "meta"                  "metags"                "metags&lt;-"             </span></span>
<span><span class="co">#&gt; [187] "minCircle"             "minmax"                "minRect"              </span></span>
<span><span class="co">#&gt; [190] "modal"                 "mosaic"                "na.omit"              </span></span>
<span><span class="co">#&gt; [193] "NAflag"                "NAflag&lt;-"              "names"                </span></span>
<span><span class="co">#&gt; [196] "ncell"                 "ncol"                  "ncol&lt;-"               </span></span>
<span><span class="co">#&gt; [199] "nearby"                "nearest"               "nlyr"                 </span></span>
<span><span class="co">#&gt; [202] "nlyr&lt;-"                "noNA"                  "normalize.longitude"  </span></span>
<span><span class="co">#&gt; [205] "north"                 "not.na"                "nrow"                 </span></span>
<span><span class="co">#&gt; [208] "nrow&lt;-"                "nsrc"                  "origin"               </span></span>
<span><span class="co">#&gt; [211] "origin&lt;-"              "pairs"                 "panel"                </span></span>
<span><span class="co">#&gt; [214] "patches"               "perim"                 "persp"                </span></span>
<span><span class="co">#&gt; [217] "plet"                  "plot"                  "plotRGB"              </span></span>
<span><span class="co">#&gt; [220] "points"                "polys"                 "prcomp"               </span></span>
<span><span class="co">#&gt; [223] "predict"               "princomp"              "project"              </span></span>
<span><span class="co">#&gt; [226] "quantile"              "query"                 "rangeFill"            </span></span>
<span><span class="co">#&gt; [229] "rapp"                  "rast"                  "rasterize"            </span></span>
<span><span class="co">#&gt; [232] "rasterizeGeom"         "rasterizeWin"          "rcl"                  </span></span>
<span><span class="co">#&gt; [235] "readRDS"               "readStart"             "readStop"             </span></span>
<span><span class="co">#&gt; [238] "readValues"            "rectify"               "regress"              </span></span>
<span><span class="co">#&gt; [241] "relate"                "removeDupNodes"        "res"                  </span></span>
<span><span class="co">#&gt; [244] "res&lt;-"                 "resample"              "rescale"              </span></span>
<span><span class="co">#&gt; [247] "rev"                   "RGB"                   "RGB&lt;-"                </span></span>
<span><span class="co">#&gt; [250] "roll"                  "rotate"                "round"                </span></span>
<span><span class="co">#&gt; [253] "rowColCombine"         "rowColFromCell"        "rowFromCell"          </span></span>
<span><span class="co">#&gt; [256] "rowFromY"              "same.crs"              "sapp"                 </span></span>
<span><span class="co">#&gt; [259] "saveRDS"               "sbar"                  "scale"                </span></span>
<span><span class="co">#&gt; [262] "scoff"                 "scoff&lt;-"               "sds"                  </span></span>
<span><span class="co">#&gt; [265] "segregate"             "sel"                   "selectHighest"        </span></span>
<span><span class="co">#&gt; [268] "selectRange"           "serialize"             "set.cats"             </span></span>
<span><span class="co">#&gt; [271] "set.crs"               "set.ext"               "set.names"            </span></span>
<span><span class="co">#&gt; [274] "set.RGB"               "set.values"            "setGDALconfig"        </span></span>
<span><span class="co">#&gt; [277] "setMinMax"             "setValues"             "shade"                </span></span>
<span><span class="co">#&gt; [280] "sharedPaths"           "shift"                 "sieve"                </span></span>
<span><span class="co">#&gt; [283] "simplifyGeom"          "size"                  "snap"                 </span></span>
<span><span class="co">#&gt; [286] "sort"                  "sources"               "spatSample"           </span></span>
<span><span class="co">#&gt; [289] "spin"                  "split"                 "sprc"                 </span></span>
<span><span class="co">#&gt; [292] "stdev"                 "stretch"               "subset"               </span></span>
<span><span class="co">#&gt; [295] "subst"                 "summary"               "Summary"              </span></span>
<span><span class="co">#&gt; [298] "svc"                   "symdif"                "t"                    </span></span>
<span><span class="co">#&gt; [301] "tail"                  "tapp"                  "terrain"              </span></span>
<span><span class="co">#&gt; [304] "terraOptions"          "text"                  "tighten"              </span></span>
<span><span class="co">#&gt; [307] "time"                  "time&lt;-"                "timeInfo"             </span></span>
<span><span class="co">#&gt; [310] "tmpFiles"              "trans"                 "trim"                 </span></span>
<span><span class="co">#&gt; [313] "union"                 "unique"                "units"                </span></span>
<span><span class="co">#&gt; [316] "units&lt;-"               "unserialize"           "unwrap"               </span></span>
<span><span class="co">#&gt; [319] "update"                "values"                "values&lt;-"             </span></span>
<span><span class="co">#&gt; [322] "varnames"              "varnames&lt;-"            "vect"                 </span></span>
<span><span class="co">#&gt; [325] "vector_layers"         "viewshed"              "voronoi"              </span></span>
<span><span class="co">#&gt; [328] "vrt"                   "vrt_tiles"             "weighted.mean"        </span></span>
<span><span class="co">#&gt; [331] "where.max"             "where.min"             "which.lyr"            </span></span>
<span><span class="co">#&gt; [334] "which.max"             "which.min"             "width"                </span></span>
<span><span class="co">#&gt; [337] "window"                "window&lt;-"              "wrap"                 </span></span>
<span><span class="co">#&gt; [340] "wrapCache"             "writeCDF"              "writeRaster"          </span></span>
<span><span class="co">#&gt; [343] "writeStart"            "writeStop"             "writeValues"          </span></span>
<span><span class="co">#&gt; [346] "writeVector"           "xapp"                  "xFromCell"            </span></span>
<span><span class="co">#&gt; [349] "xFromCol"              "xmax"                  "xmax&lt;-"               </span></span>
<span><span class="co">#&gt; [352] "xmin"                  "xmin&lt;-"                "xres"                 </span></span>
<span><span class="co">#&gt; [355] "xyFromCell"            "yFromCell"             "yFromRow"             </span></span>
<span><span class="co">#&gt; [358] "ymax"                  "ymax&lt;-"                "ymin"                 </span></span>
<span><span class="co">#&gt; [361] "ymin&lt;-"                "yres"                  "zonal"                </span></span>
<span><span class="co">#&gt; [364] "zoom"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s create an empty RasterLayer object - we have to define the matrix (rows and columns) the spatial bounding box, and then we provide values to the cells using the runif function to derive random values from the uniform distribution.</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">10</span>, nrow <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span>n<span class="op">=</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html">ncell</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r</span></span>
<span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; dimensions  : 10, 10, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 36, 18  (x, y)</span></span>
<span><span class="co">#&gt; extent      : -180, 180, -90, 90  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : lon/lat WGS 84 </span></span>
<span><span class="co">#&gt; source(s)   : memory</span></span>
<span><span class="co">#&gt; name        :      lyr.1 </span></span>
<span><span class="co">#&gt; min value   : 0.01040053 </span></span>
<span><span class="co">#&gt; max value   : 0.98972633</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="gis-in-r_files/figure-html/basic-raster-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Basic raster dataset in R.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>The raster we made from scratch is in memory but very small. An important feature of the <code>terra</code> package is that when you load a raster from file, it is not actually loaded into memory. Instead, <code>terra</code> reads information about the raster into memory, such as its dimensions, its extent, and more. This makes working with rasters lightweight, as it will only ever load into memory what is needed for a specific task. For example, you can access raster values via direct indexing or line/column indexing. The <code>terra</code> package accesses just those locations on the disk. Take a minute to see how this works using the raster <code>r</code> that we just created - the syntax is:</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Access data from the ith location in a raster</span></span>
<span><span class="va">r</span><span class="op">[</span><span class="fl">12</span><span class="op">]</span></span>
<span><span class="co">#&gt;       lyr.1</span></span>
<span><span class="co">#&gt; 1 0.1128865</span></span>
<span></span>
<span><span class="co"># Access data based on row and column</span></span>
<span><span class="va">r</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span> </span>
<span><span class="co">#&gt;       lyr.1</span></span>
<span><span class="co">#&gt; 1 0.1128865</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="stacking-raster-data" class="level3" data-number="4.3.1"><h3 data-number="4.3.1" class="anchored" data-anchor-id="stacking-raster-data">
<span class="header-section-number">4.3.1</span> Stacking raster data</h3>
<p>Often, it can be very efficient to work with mutliple rasters at once. Raster data is often distributed in stacks, such as climate data as a NetCDF file.</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create 2 new rasters based on raster r</span></span>
<span></span>
<span><span class="va">r2</span> <span class="op">&lt;-</span> <span class="va">r</span> <span class="op">*</span> <span class="fl">50</span></span>
<span><span class="va">r3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">r</span> <span class="op">*</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Stack rasters and rename to be unique</span></span>
<span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">r2</span>, <span class="va">r3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html">names</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'r1'</span>, <span class="st">'r2'</span>, <span class="st">'r3'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="gis-in-r_files/figure-html/stacked-rasters-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Plot of stacked rasters in R.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Manipulate all rasters in stack</span></span>
<span></span>
<span><span class="va">s2</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">s</span> <span class="op">+</span> <span class="fl">5</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3</span></span>
<span></span>
<span><span class="co"># Give modified rasters a new name (add "modified")</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html">names</a></span><span class="op">(</span><span class="va">s2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html">names</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span>, <span class="st">" modified"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">s2</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="gis-in-r_files/figure-html/modified-stacked-rasters-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Plot of stacked rasters in R.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Reclassifying rasters
</div>
</div>
<div class="callout-body-container callout-body">
<p>You can also relcassify rasters values with <code><a href="https://rspatial.github.io/terra/reference/classify.html">terra::classify()</a></code></p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="co"># Create a matrix where first 2 values are raster values and third value is the class value:</span></span>
<span><span class="va">class_table</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span>,</span>
<span>                  <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">3</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Reclassify r based on the reclass matrix</span></span>
<span><span class="va">rcls</span> <span class="op">&lt;-</span> <span class="va">r</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/classify.html">classify</a></span><span class="op">(</span><span class="va">class_table</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">rcls</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="gis-in-r_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</div>
</section></section><section id="working-with-real-data" class="level2" data-number="4.4"><h2 data-number="4.4" class="anchored" data-anchor-id="working-with-real-data">
<span class="header-section-number">4.4</span> Working with real data</h2>
<p>There are several (often very new) <code>R</code> packages for accessing and working with spatial data. In this code, we will use the<code>FedData</code> <code>R</code> package to download National Elevation Data. Although this example focuses on digital elevation data, the <code>FedData</code> package provides access to several federal datasets, including the National Land Cover Database (NLCD).</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Select just Corvallis and calculate a 10,000-m buffer</span></span>
<span><span class="va">corvallis</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">oregon_cities</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">cities</span> <span class="op">==</span> <span class="st">'Corvallis'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span><span class="fl">10000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Download national elevation data (ned)</span></span>
<span><span class="va">ned</span> <span class="op">&lt;-</span> <span class="fu">FedData</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/FedData/reference/get_ned.html">get_ned</a></span><span class="op">(</span></span>
<span>  template <span class="op">=</span> <span class="va">corvallis</span>,</span>
<span>  label <span class="op">=</span> <span class="st">"corvallis"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html">names</a></span><span class="op">(</span><span class="va">ned</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"elevation"</span></span>
<span></span>
<span><span class="co"># Check whether the elevation and buffer data share the same geographic reference system</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">ned</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">corvallis</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can transform the projection of the raster with <code><a href="https://rspatial.github.io/terra/reference/project.html">terra::project()</a></code>. Because the raster represents continuous data, we will use the bilinear interpolation method. For categorical data (e.g., land cover), it is best to use <code>method = 'near'</code></p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ned</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/project.html">project</a></span><span class="op">(</span><span class="va">ned</span>, </span>
<span>                      <span class="st">'epsg:5070'</span>,</span>
<span>                      method <span class="op">=</span> <span class="st">'bilinear'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>tidyterra</code> package gives us a new “geometry” for ggplot called <code><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">tidyterra</span><span class="fu">::</span><span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ned</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">corvallis</span>, </span>
<span>          fill <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>          color <span class="op">=</span> <span class="st">'white'</span>, </span>
<span>          lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="gis-in-r_files/figure-html/elevation-ggplot-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">ggplot of elevation data.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>In addition to elevation, we can derive several topographic indices, including slope and roughness.</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Calculate several terrain metrics</span></span>
<span><span class="op">?</span><span class="fu">terra</span><span class="fu">::</span><span class="va"><a href="https://rspatial.github.io/terra/reference/terrain.html">terrain</a></span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To calculate these metrics on the elevation raster, we can use the <code><a href="https://rspatial.github.io/terra/reference/terrain.html">terrain()</a></code> function from the <code>terra</code> package.</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Calculate several terrain metrics</span></span>
<span><span class="va">terrain_metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/terrain.html">terrain</a></span><span class="op">(</span><span class="va">ned</span>, </span>
<span>                           v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'slope'</span>, <span class="st">'roughness'</span>, <span class="st">'TRI'</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ned</span>, <span class="va">terrain_metrics</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="gis-in-r_files/figure-html/terrain-plots-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Plot of elevation-derived terrain metrics.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">terrain_metrics</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">lyr</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/scale_whitebox.html">scale_fill_whitebox_c</a></span><span class="op">(</span></span>
<span>    palette <span class="op">=</span> <span class="st">"muted"</span>,</span>
<span>    n.breaks <span class="op">=</span> <span class="fl">12</span>,</span>
<span>    guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="gis-in-r_files/figure-html/terrain-ggplots-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">ggplots of elevation-derived terrain metrics.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>What if we want to know the average of elevation, slope, etc. within the buffered area of Corvallis?</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># First, let's combine into a single stack of rasters</span></span>
<span><span class="va">terrain_metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">terrain_metrics</span>, <span class="va">ned</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># zonal function in terra to calculate zonal statistics</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/zonal.html">zonal</a></span><span class="op">(</span><span class="va">terrain_metrics</span>, </span>
<span>             </span>
<span>             <span class="co"># Need to convert corvallis `sf` object to terra vector</span></span>
<span>             <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html">vect</a></span><span class="op">(</span><span class="va">corvallis</span><span class="op">)</span>, </span>
<span>             </span>
<span>             <span class="co"># Metric to be calculated</span></span>
<span>             <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="co">#&gt;      slope roughness      TRI elevation</span></span>
<span><span class="co">#&gt; 1 4.638052  5.604068 1.717456  119.6678</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In addition to zonal statistics, the <code>terra</code> package can be used to extract (<code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code>) the total number of pixels of different categories within a polygon, which can be converted to area (see exercise below). <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> is also used to drop points through raster to obtain data at lat/lon locations.</p>
<div class="callout-important callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Exercise
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Create a layer of U.S. cities with <code>data('us.cities')</code> from the <code>maps</code> library.</li>
<li>Select the city of your choice and buffer it by 10Km. (We suggest converting to an equal area projection first).</li>
<li>Read in NLCD land cover data for your city with the <code>FedData</code> package.</li>
<li>Calculate the % of the buffer around your city that is composed of row crop.</li>
</ol>
</div>
</div>
<div class="callout-important callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Exercise Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">'us.cities'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">my_city</span> <span class="op">&lt;-</span> <span class="va">us.cities</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">name</span> <span class="op">==</span> <span class="st">'Idaho Falls ID'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'long'</span>, <span class="st">'lat'</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4269</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="fl">5070</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span><span class="fl">10000</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nlcd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/FedData/reference/get_nlcd.html">get_nlcd</a></span><span class="op">(</span></span>
<span>  template <span class="op">=</span> <span class="va">my_city</span>,</span>
<span>  year <span class="op">=</span> <span class="fl">2021</span>,</span>
<span>  label <span class="op">=</span> <span class="st">'city'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/project.html">project</a></span><span class="op">(</span><span class="st">'epsg:5070'</span>,</span>
<span>               method <span class="op">=</span> <span class="st">'near'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">city_nlcd</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">nlcd</span>, </span>
<span>                            <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html">vect</a></span><span class="op">(</span><span class="va">my_city</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">city_nlcd</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Class</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>percent <span class="op">=</span> <span class="op">(</span><span class="va">count</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 13 × 3</span></span>
<span><span class="co">#&gt;    Class                         count  percent</span></span>
<span><span class="co">#&gt;    &lt;fct&gt;                         &lt;int&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 Open Water                     4189  1.20   </span></span>
<span><span class="co">#&gt;  2 Developed, Open Space         31025  8.89   </span></span>
<span><span class="co">#&gt;  3 Developed, Low Intensity      43040 12.3    </span></span>
<span><span class="co">#&gt;  4 Developed, Medium Intensity   38470 11.0    </span></span>
<span><span class="co">#&gt;  5 Developed High Intensity       6778  1.94   </span></span>
<span><span class="co">#&gt;  6 Barren Land (Rock/Sand/Clay)   1511  0.433  </span></span>
<span><span class="co">#&gt;  7 Evergreen Forest                  9  0.00258</span></span>
<span><span class="co">#&gt;  8 Shrub/Scrub                    4991  1.43   </span></span>
<span><span class="co">#&gt;  9 Grassland/Herbaceous           2633  0.755  </span></span>
<span><span class="co">#&gt; 10 Pasture/Hay                      98  0.0281 </span></span>
<span><span class="co">#&gt; 11 Cultivated Crops             215924 61.9    </span></span>
<span><span class="co">#&gt; 12 Woody Wetlands                   88  0.0252 </span></span>
<span><span class="co">#&gt; 13 Emergent Herbaceous Wetlands    147  0.0421</span></span>
<span></span>
<span><span class="co"># Bonus: mapping land cover w/ city radius</span></span>
<span></span>
<span><span class="co"># Mask then crop the NLCD to the buffer</span></span>
<span><span class="va">nlcd_crop</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html">mask</a></span><span class="op">(</span><span class="va">nlcd</span>, <span class="va">my_city</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html">crop</a></span><span class="op">(</span><span class="va">my_city</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">nlcd_crop</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">my_city</span>,</span>
<span>          fill <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>          lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="gis-in-r_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</div>
</div>
<p>Zonal statistics and tabulation of areas are fundamental to generating data summaries that are useful for ecological/statistical analyses, and the <code>terra</code> package has greatly improved the processing speed of zonal stats in <code>R</code>.</p>
<p>However, most analyses in aquatic ecology are not based on buffered points, like we covered here. In addition, zonal statistics over large geographic areas can still be a big task for <code>R</code>, such as for large watersheds.</p>
<p>In the next sections, we’ll first cover how to generate watershed boundaries to generate watershed summaries. After that, we’ll discuss the <code>StreamCatTools</code> package for accessing a variety of watershed metrics for which the zonal statistics have already been calculated.</p>
</section><section id="r-code-appendix" class="level2" data-number="4.5"><h2 data-number="4.5" class="anchored" data-anchor-id="r-code-appendix">
<span class="header-section-number">4.5</span> R Code Appendix</h2>
<div class="cell">

</div>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/FedData/">FedData</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dieghernan.github.io/tidyterra/">tidyterra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">maps</span><span class="op">)</span></span>
<span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">cities</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Ashland'</span>,<span class="st">'Corvallis'</span>,<span class="st">'Bend'</span>,<span class="st">'Portland'</span>,<span class="st">'Newport'</span><span class="op">)</span></span>
<span><span class="va">longitude</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">122.699</span>, <span class="op">-</span><span class="fl">123.275</span>, <span class="op">-</span><span class="fl">121.313</span>, <span class="op">-</span><span class="fl">122.670</span>, <span class="op">-</span><span class="fl">124.054</span><span class="op">)</span></span>
<span><span class="va">latitude</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">42.189</span>, <span class="fl">44.57</span>, <span class="fl">44.061</span>, <span class="fl">45.523</span>, <span class="fl">44.652</span><span class="op">)</span></span>
<span><span class="va">population</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20062</span>, <span class="fl">50297</span>, <span class="fl">61362</span>, <span class="fl">537557</span>, <span class="fl">9603</span><span class="op">)</span></span>
<span></span>
<span><span class="va">oregon_cities</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">cities</span>, <span class="va">longitude</span>, <span class="va">latitude</span>, <span class="va">population</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">oregon_cities</span>, </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">longitude</span>, y <span class="op">=</span> <span class="va">latitude</span>, size <span class="op">=</span> <span class="va">population</span>, label <span class="op">=</span> <span class="va">cities</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">1</span>, vjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="st">"package:sf"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">oregon_cities</span><span class="op">)</span></span>
<span></span>
<span><span class="va">oregon_cities</span> <span class="op">&lt;-</span> <span class="va">oregon_cities</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'longitude'</span>, <span class="st">'latitude'</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4269</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">oregon_cities</span><span class="op">)</span></span>
<span><span class="va">oregon_cities</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">cities</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">oregon_cities</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="fl">5070</span><span class="op">)</span></span>
<span></span>
<span><span class="va">oregon_cities</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">oregon_cities</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="fl">5070</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">oregon_cities</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">oregon_cities</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">cities</span><span class="op">)</span>,</span>
<span>               hjust<span class="op">=</span><span class="fl">0</span>, vjust<span class="op">=</span><span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">population</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">'Longitude'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">'Latitude'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Plot 1:</span></span>
<span></span>
<span><span class="co"># Add 100 Km buffer to cities</span></span>
<span><span class="va">cities_buffer</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">oregon_cities</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span><span class="fl">100000</span><span class="op">)</span></span>
<span><span class="co"># Plot, color by city, and add centroids</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">cities_buffer</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">cities</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span><span class="va">oregon_cities</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Plot 2:</span></span>
<span></span>
<span><span class="va">oregon_cities</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  </span>
<span>  <span class="co"># 100 Km buffer</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span><span class="fl">100000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># Split polygons where buffers intersect</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">st_intersection</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># Add area to table, but drop units (causes issues with ggplot)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>area <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_area</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>           <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/drop_units.html">drop_units</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         id <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/is.bool.html">as.factor</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">id</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="st">"package:terra"</span><span class="op">)</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">10</span>, nrow <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span>n<span class="op">=</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html">ncell</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="co"># Access data from the ith location in a raster</span></span>
<span><span class="va">r</span><span class="op">[</span><span class="fl">12</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Access data based on row and column</span></span>
<span><span class="va">r</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span> </span>
<span><span class="co"># Create 2 new rasters based on raster r</span></span>
<span></span>
<span><span class="va">r2</span> <span class="op">&lt;-</span> <span class="va">r</span> <span class="op">*</span> <span class="fl">50</span></span>
<span><span class="va">r3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">r</span> <span class="op">*</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Stack rasters and rename to be unique</span></span>
<span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">r2</span>, <span class="va">r3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html">names</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'r1'</span>, <span class="st">'r2'</span>, <span class="st">'r3'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span>
<span><span class="co"># Manipulate all rasters in stack</span></span>
<span></span>
<span><span class="va">s2</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">s</span> <span class="op">+</span> <span class="fl">5</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3</span></span>
<span></span>
<span><span class="co"># Give modified rasters a new name (add "modified")</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html">names</a></span><span class="op">(</span><span class="va">s2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html">names</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span>, <span class="st">" modified"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">s2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a matrix where first 2 values are raster values and third value is the class value:</span></span>
<span><span class="va">class_table</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span>,</span>
<span>                  <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">3</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Reclassify r based on the reclass matrix</span></span>
<span><span class="va">rcls</span> <span class="op">&lt;-</span> <span class="va">r</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/classify.html">classify</a></span><span class="op">(</span><span class="va">class_table</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">rcls</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Select just Corvallis and calculate a 10,000-m buffer</span></span>
<span><span class="va">corvallis</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">oregon_cities</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">cities</span> <span class="op">==</span> <span class="st">'Corvallis'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span><span class="fl">10000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Download national elevation data (ned)</span></span>
<span><span class="va">ned</span> <span class="op">&lt;-</span> <span class="fu">FedData</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/FedData/reference/get_ned.html">get_ned</a></span><span class="op">(</span></span>
<span>  template <span class="op">=</span> <span class="va">corvallis</span>,</span>
<span>  label <span class="op">=</span> <span class="st">"corvallis"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html">names</a></span><span class="op">(</span><span class="va">ned</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"elevation"</span></span>
<span></span>
<span><span class="co"># Check whether the elevation and buffer data share the same geographic reference system</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">ned</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">corvallis</span><span class="op">)</span></span>
<span><span class="va">ned</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/project.html">project</a></span><span class="op">(</span><span class="va">ned</span>, </span>
<span>                      <span class="st">'epsg:5070'</span>,</span>
<span>                      method <span class="op">=</span> <span class="st">'bilinear'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">tidyterra</span><span class="fu">::</span><span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ned</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">corvallis</span>, </span>
<span>          fill <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>          color <span class="op">=</span> <span class="st">'white'</span>, </span>
<span>          lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Calculate several terrain metrics</span></span>
<span><span class="op">?</span><span class="fu">terra</span><span class="fu">::</span><span class="va"><a href="https://rspatial.github.io/terra/reference/terrain.html">terrain</a></span></span>
<span><span class="co"># Calculate several terrain metrics</span></span>
<span><span class="va">terrain_metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/terrain.html">terrain</a></span><span class="op">(</span><span class="va">ned</span>, </span>
<span>                           v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'slope'</span>, <span class="st">'roughness'</span>, <span class="st">'TRI'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ned</span>, <span class="va">terrain_metrics</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">terrain_metrics</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">lyr</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/scale_whitebox.html">scale_fill_whitebox_c</a></span><span class="op">(</span></span>
<span>    palette <span class="op">=</span> <span class="st">"muted"</span>,</span>
<span>    n.breaks <span class="op">=</span> <span class="fl">12</span>,</span>
<span>    guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># First, let's combine into a single stack of rasters</span></span>
<span><span class="va">terrain_metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">terrain_metrics</span>, <span class="va">ned</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># zonal function in terra to calculate zonal statistics</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/zonal.html">zonal</a></span><span class="op">(</span><span class="va">terrain_metrics</span>, </span>
<span>             </span>
<span>             <span class="co"># Need to convert corvallis `sf` object to terra vector</span></span>
<span>             <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html">vect</a></span><span class="op">(</span><span class="va">corvallis</span><span class="op">)</span>, </span>
<span>             </span>
<span>             <span class="co"># Metric to be calculated</span></span>
<span>             <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">'us.cities'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">my_city</span> <span class="op">&lt;-</span> <span class="va">us.cities</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">name</span> <span class="op">==</span> <span class="st">'Idaho Falls ID'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'long'</span>, <span class="st">'lat'</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4269</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="fl">5070</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span><span class="fl">10000</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nlcd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/FedData/reference/get_nlcd.html">get_nlcd</a></span><span class="op">(</span></span>
<span>  template <span class="op">=</span> <span class="va">my_city</span>,</span>
<span>  year <span class="op">=</span> <span class="fl">2021</span>,</span>
<span>  label <span class="op">=</span> <span class="st">'city'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/project.html">project</a></span><span class="op">(</span><span class="st">'epsg:5070'</span>,</span>
<span>               method <span class="op">=</span> <span class="st">'near'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">city_nlcd</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">nlcd</span>, </span>
<span>                            <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html">vect</a></span><span class="op">(</span><span class="va">my_city</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">city_nlcd</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Class</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>percent <span class="op">=</span> <span class="op">(</span><span class="va">count</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bonus: mapping land cover w/ city radius</span></span>
<span></span>
<span><span class="co"># Mask then crop the NLCD to the buffer</span></span>
<span><span class="va">nlcd_crop</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html">mask</a></span><span class="op">(</span><span class="va">nlcd</span>, <span class="va">my_city</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html">crop</a></span><span class="op">(</span><span class="va">my_city</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">nlcd_crop</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">my_city</span>,</span>
<span>          fill <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>          lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./spglm.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial Generalized Linear Models (SPGLMs) in <code>spmodel</code></span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./watershed-delineation.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Watershed Delineation in <code>R</code></span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">Workshop materials created by Michael Dumelle and Ryan Hill</div>   
    <div class="nav-footer-right">This book was built with <a href="https://quarto.org/">Quarto</a>.</div>
  </div>
</footer>


</body></html>